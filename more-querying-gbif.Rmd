---
title: "More Querying GBIF Data"
output: pdf_document
---

Your name here  
Assignment 3  
DSCI 245 / RNR 496B  
Due: February 8th, 2022  


## More Querying GBIF Data


### Learning objectives:
* Understand how to query GBIF data with spocc, using a variety of arguments.
* Learn how to create a derivative data set with fewer columns and use some cleaning strategies.  
* Learn how to combine data sets.  
* Successfully create a csv file from a data set.  



### Querying data from GBIF with spocc  

Picking up from last week, we're going to dive back into querying data from GBIF (Global Biodversity Information Facility) using the spocc (SPecies OCCurrence) R package. First, let's load the spocc package using the library() function:


```{r}

library("spocc")

```


Now, let's revisit the "occ()" function. The documenation for this function is available here:

https://docs.ropensci.org/spocc/reference/occ.html

Let's start by revisiting how to run a basic query to get species occurrences from GBIF. The following example will gives us data from GBIF on Southern Black Widows (Latrodectus mactans):

```{r}

#Note the default limit is 500, so run your query once, view the total, and then adjust your limit so it exceeds the max, and run again.

blackWidows<-occ(query='Latrodectus mactans', from="gbif", limit=4000)

blackWidows


```

One thing we didn't look at last week was the "View()" function. If you recall, occ() returns an "object", which is basically a series of hierarchical data containing various pieces of information. We can navigate the object using the "$" operator, but it's only really useful if we know how to navigate the object. So let's run "View()" on blackWidows, and see what we get:

```{r}

View(blackWidows)

```

You'll notice this opens up a new tab in RStudio, and shows us what's inside the object, and how to navigate it. You can see by clicking the various arrows that we can navigate to the data by this path: blackWidows$gbif$data$ Latrodectus_mactans

```{r}

bwData<-blackWidows$gbif$data$Latrodectus_mactans

bwData

```


YOUR TURN:

* Pick a bird from the Internet Bird Collection: https://search.macaulaylibrary.org/catalog?sort=rating_rank_desc&collection=COLL58&cap=all&includeUnconfirmed=T
* Use the species name to query GBIF using the occ() function. 
* Use the View() function to see the object hierarchy.
* Create a variable to target the data set from the object, and print it to the screen.


```{r}

# Create a variable set to the initial occ() query


# Use View() to see the object result


# Create another variable to target the data set, and then print to screen



```


### Further refining GBIF queries

The occ() function has many arguments to help refine our query. One particularly useful argument is "gbifopts", which provides a number of additional arguments specific to GBIF queries (remember, occ() can query multiple data sources...each one has their own 'opts' argument). 


We can look at all the possibilities for "gbifopts" by running the following:

```{r}
occ_options('gbif')
```

You can contain gbifopts in an R "list". The syntax for using a list is:

list(key1="value1", key2="value2")

Below I'm refining the query for the Southern Black Widow to just those in Texas during the year 2020:

```{r}

bwTx<-occ(query="Latrodectus mactans", from="gbif", gbifopts = list(stateProvince="Texas", year="2020"))

bwTx

```

YOUR TURN:

Refine your bird query to just return occurrences in a country of your choosing, for the years 2020 and 2021 (hint: refer to occ_options('gbif') to determine how to query multiple years, and how to query by country):

```{r}

# Run the occ() query


# use View() to see the object


# Define a new variable, and print to the screen.



```




```{r}
# testing 
#pinnated bittern
#western meadowlark
wml<-occ(query="Sturnella neglecta", gbifopts = list(year="2020", stateProvince="Oregon"), limit=12000, has_coords = TRUE)
wml


```

```{r}
#View(bittern)

wmlData<-wml$gbif$data$Sturnella_neglecta

wmlData

#library(mapr)

#map_leaflet(wmlData)

```






### Analyzing/cleaning your data

Since humans are involved in recording and submitting the data, you can't necessarily assume it's all accurate. As such, we should probably write some scripts to "clean" the data.




```{r}

unique(wmlData$occurrenceStatus)

unique(wmlData$individualCount)

to_remove<-subset(wmlData, individualCount==31)
to_remove



```



geo checking, 
taxonomy can get wonky
exclude w/in North America
dates!

Looking at the output of the data, it's safe to say that there are many columns that we simply don't need. While they don't hurt anything, it might be easier to work with if we can pare down the size of our data set...at least in terms of columns.



---sample & exercise picking columns for new data set




### Save as CSV

### Integrate CSV (date, georef (format/validity), taxonomy)

super-milkweed-data (same species, mult sources)



